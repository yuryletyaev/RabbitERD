<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Тест исправленных координат</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        #diagram { width: 100%; height: 400px; border: 1px solid #ccc; }
        .success { color: green; }
        .error { color: red; }
    </style>
</head>
<body>
    <h1>Тест исправленных координат</h1>
    <div id="status"></div>
    <svg id="diagram" width="100%" height="400"></svg>
    
    <script>
        // Тестовые данные с потенциально undefined координатами
        const testData = {
            nodes: [
                { id: 'node1', name: 'Node 1', x: undefined, y: undefined },
                { id: 'node2', name: 'Node 2', x: 100, y: 100 },
                { id: 'node3', name: 'Node 3', x: null, y: null }
            ],
            links: [
                { source: 'node1', destination: 'node2' },
                { source: 'node2', destination: 'node3' }
            ]
        };
        
        function testCoordinates() {
            const status = document.getElementById('status');
            
            try {
                const svg = d3.select('#diagram');
                const g = svg.append('g');
                
                // Создание узлов
                const node = g.append('g')
                    .attr('class', 'nodes')
                    .selectAll('g')
                    .data(testData.nodes)
                    .enter().append('g')
                    .attr('class', 'node');
                
                // Прямоугольники
                node.append('rect')
                    .attr('width', 100)
                    .attr('height', 50)
                    .attr('fill', '#4CAF50')
                    .attr('stroke', '#333');
                
                // Текст
                node.append('text')
                    .attr('x', 50)
                    .attr('y', 25)
                    .attr('text-anchor', 'middle')
                    .attr('dy', '0.35em')
                    .attr('fill', 'white')
                    .text(d => d.name);
                
                // Позиционирование с проверкой координат
                node.attr('transform', d => {
                    const x = d.x || 0;
                    const y = d.y || 0;
                    return `translate(${x}, ${y})`;
                });
                
                // Создание связей
                const link = g.append('g')
                    .attr('class', 'links')
                    .selectAll('line')
                    .data(testData.links)
                    .enter().append('line')
                    .attr('stroke', '#FF9800')
                    .attr('stroke-width', 2);
                
                // Позиционирование связей с проверкой координат
                link
                    .attr('x1', d => {
                        const source = testData.nodes.find(n => n.id === d.source);
                        return source && source.x ? source.x : 0;
                    })
                    .attr('y1', d => {
                        const source = testData.nodes.find(n => n.id === d.source);
                        return source && source.y ? source.y : 0;
                    })
                    .attr('x2', d => {
                        const dest = testData.nodes.find(n => n.id === d.destination);
                        return dest && dest.x ? dest.x : 0;
                    })
                    .attr('y2', d => {
                        const dest = testData.nodes.find(n => n.id === d.destination);
                        return dest && dest.y ? dest.y : 0;
                    });
                
                status.innerHTML = '<p class="success">✅ Тест координат пройден успешно</p>';
                
            } catch (error) {
                document.getElementById('status').innerHTML = `<p class="error">❌ Ошибка: ${error.message}</p>`;
                console.error('Ошибка тестирования координат:', error);
            }
        }
        
        // Запуск теста при загрузке
        window.addEventListener('load', testCoordinates);
    </script>
</body>
</html>
