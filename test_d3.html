<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Тест D3.js</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        #test-container { width: 100%; height: 400px; border: 1px solid #ccc; }
        .success { color: green; }
        .error { color: red; }
    </style>
</head>
<body>
    <h1>Тест D3.js</h1>
    <div id="status"></div>
    <div id="test-container"></div>
    
    <script>
        function testD3() {
            const status = document.getElementById('status');
            const container = document.getElementById('test-container');
            
            try {
                // Проверка D3
                if (typeof d3 === 'undefined') {
                    status.innerHTML = '<p class="error">❌ D3.js не загружен</p>';
                    return;
                }
                
                status.innerHTML = '<p class="success">✅ D3.js загружен</p>';
                
                // Создание SVG
                const svg = d3.select('#test-container')
                    .append('svg')
                    .attr('width', '100%')
                    .attr('height', '100%');
                
                // Тестовые данные
                const nodes = [
                    { id: 'node1', name: 'Exchange 1', type: 'exchange', x: 100, y: 100 },
                    { id: 'node2', name: 'Queue 1', type: 'queue', x: 300, y: 100 },
                    { id: 'node3', name: 'Queue 2', type: 'queue', x: 200, y: 250 }
                ];
                
                const links = [
                    { source: 'node1', destination: 'node2' },
                    { source: 'node1', destination: 'node3' }
                ];
                
                // Создание связей
                const link = svg.append('g')
                    .attr('class', 'links')
                    .selectAll('line')
                    .data(links)
                    .enter().append('line')
                    .attr('stroke', '#FF9800')
                    .attr('stroke-width', 2);
                
                // Создание узлов
                const node = svg.append('g')
                    .attr('class', 'nodes')
                    .selectAll('g')
                    .data(nodes)
                    .enter().append('g')
                    .attr('class', 'node');
                
                // Прямоугольники
                node.append('rect')
                    .attr('width', 120)
                    .attr('height', 60)
                    .attr('rx', 10)
                    .attr('fill', d => d.type === 'exchange' ? '#4CAF50' : '#2196F3')
                    .attr('stroke', '#333')
                    .attr('stroke-width', 2);
                
                // Текст
                node.append('text')
                    .attr('x', 60)
                    .attr('y', 30)
                    .attr('text-anchor', 'middle')
                    .attr('dy', '0.35em')
                    .attr('fill', 'white')
                    .attr('font-weight', 'bold')
                    .attr('font-size', '12px')
                    .text(d => d.name);
                
                // Позиционирование
                node.attr('transform', d => `translate(${d.x - 60}, ${d.y - 30})`);
                
                // Обновление связей
                link
                    .attr('x1', d => {
                        const source = nodes.find(n => n.id === d.source);
                        return source ? source.x : 0;
                    })
                    .attr('y1', d => {
                        const source = nodes.find(n => n.id === d.source);
                        return source ? source.y : 0;
                    })
                    .attr('x2', d => {
                        const dest = nodes.find(n => n.id === d.destination);
                        return dest ? dest.x : 0;
                    })
                    .attr('y2', d => {
                        const dest = nodes.find(n => n.id === d.destination);
                        return dest ? dest.y : 0;
                    });
                
                status.innerHTML += '<p class="success">✅ Визуализация создана успешно</p>';
                
            } catch (error) {
                status.innerHTML += `<p class="error">❌ Ошибка: ${error.message}</p>`;
                console.error('Ошибка тестирования D3:', error);
            }
        }
        
        // Запуск теста при загрузке
        window.addEventListener('load', testD3);
    </script>
</body>
</html>
